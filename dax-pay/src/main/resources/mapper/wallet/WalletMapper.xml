<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bootx.platform.daxpay.core.channel.wallet.dao.WalletMapper">

    <!--预冻结金额-->
    <update id="freezeBalance">
        update pay_wallet
        set freeze_balance = #{amount},
            last_modifier = #{operator},
            last_modified_time = #{date},
            version = (version+1)
        where id = #{walletId} and (balance - freeze_balance - #{amount}) >= 0
    </update>
    <!--解冻金额-->
    <update id="unfreezeBalance">
        update pay_wallet
        set freeze_balance = (freeze_balance - #{amount}),
            last_modifier = #{operator},
            last_modified_time = #{date},
            version = (version+1)
        where id = #{walletId} and (freeze_balance - #{amount}) >= 0
    </update>

    <!-- 减少余额 -->
    <update id="reduceBalance">
        update pay_wallet
        set balance = (balance - #{amount}),
            last_modifier = #{operator},
            last_modified_time = #{date},
            version = (version+1)
        where id = #{walletId} and (balance - freeze_balance- #{amount}) >= 0
    </update>

    <!-- 扣减余额同时解除预冻结的额度 -->
    <update id="reduceAndUnfreezeBalance">
        update pay_wallet
        set balance = (balance - #{amount}),
            freeze_balance = (freeze_balance - #{amount}),
            last_modifier = #{operator},
            last_modified_time = #{date},
            version = (version+1)
        where id = #{walletId} and (freeze_balance- #{amount}) >= 0
    </update>

    <!--增加余额-->
    <update id="increaseBalance">
        update pay_wallet
        set balance = (balance + #{amount}),
            last_modifier = #{operator},
            last_modified_time = #{date},
            version = (version+1)
        where id = #{walletId}
    </update>

    <!-- 减少余额,允许扣成负数 -->
    <update id="reduceBalanceUnlimited">
        update pay_wallet
        set balance = (balance - #{amount}),
            last_modifier = #{operator},
            last_modified_time = #{date},
            version = (version+1)
        where id = #{walletId}
    </update>

    <!-- 待开通钱包的用户列表 -->
    <select id="pageByNotWallet" resultType="cn.bootx.platform.iam.core.user.entity.UserInfo">
        select
            iam_user_info.id,
            iam_user_info.`name`,
            iam_user_info.username
        from
            iam_user_info
                LEFT JOIN
            pay_wallet AS w
            on
                iam_user_info.id = w.user_id
        ${ew.customSqlSegment}
    </select>


</mapper>
